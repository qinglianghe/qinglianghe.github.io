<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="ORM全称“Object Relational Mapping”，即对象-关系映射，就是把关系数据库的一行映射为一个对象，也就是一个类对应一个表，这样，写代码更简单，不用直接操作SQL语句。">
<meta property="og:type" content="article">
<meta property="og:title" content="编写python ORM框架">
<meta property="og:url" content="http://yoursite.com/2018/05/27/orm/index.html">
<meta property="og:site_name" content="heqingliang&#39;s Blog">
<meta property="og:description" content="ORM全称“Object Relational Mapping”，即对象-关系映射，就是把关系数据库的一行映射为一个对象，也就是一个类对应一个表，这样，写代码更简单，不用直接操作SQL语句。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-05-31T19:04:06.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="编写python ORM框架">
<meta name="twitter:description" content="ORM全称“Object Relational Mapping”，即对象-关系映射，就是把关系数据库的一行映射为一个对象，也就是一个类对应一个表，这样，写代码更简单，不用直接操作SQL语句。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/05/27/orm/"/>





  <title>编写python ORM框架 | heqingliang's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">heqingliang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/27/orm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="heqingliang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dva.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="heqingliang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">编写python ORM框架</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-27T00:00:00+08:00">
                2018-05-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<p><code>ORM</code>全称“Object Relational Mapping”，即对象-关系映射，就是把关系数据库的一行映射为一个对象，也就是一个类对应一个表，这样，写代码更简单，不用直接操作<code>SQL</code>语句。<br><a id="more"></a><br>要编写一个<code>ORM</code>框架，所有的类都只能动态定义，因为只有使用者才能根据表的结构定义出对应的类来。在<code>Python</code>中类的动态定义可以由元类来实现。</p>
<h3 id="元类"><a href="#元类" class="headerlink" title="元类"></a>元类</h3><h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><p><code>type</code>函数不仅可以查看一个类型或变量的类型，<code>type</code>也能动态的创建类。<code>type</code>可以接受一个类的描述作为参数，然后返回一个类。</p>
<p><code>type</code>可以像这样工作：</p>
<pre><code>type(类名, 父类的元组（针对继承的情况，可以为空），包含属性的字典（名称和值）)
</code></pre><p>比如下面的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(self, name=<span class="string">'world'</span>)</span>:</span></span><br><span class="line">        print(<span class="string">'Hello, %s'</span>, % name)</span><br></pre></td></tr></table></figure>
<p>可以手动像这样创建：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">fn</span><span class="params">(self, name=<span class="string">'world'</span>)</span>:</span></span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s'</span> % name)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Hello = type(<span class="string">'Hello'</span>, (object,), dict(hello=fn))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h = Hello()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h.hello()</span><br><span class="line">Hello, world</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(type(Hello))</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">type</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">print</span><span class="params">(type<span class="params">(h)</span>)</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">Hello</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到使用<code>type</code>函数创建的类和直接写class是完全一样的，因为<code>type</code>就是<code>Python</code>在背后用来创建所有类的元类。<code>Python</code>解释器在遇到class定义时，仅仅是扫描一下class定义的语法，然后调用<code>type()</code>函数创建出class。</p>
<h4 id="metaclass"><a href="#metaclass" class="headerlink" title="metaclass"></a>metaclass</h4><p>除了使用<code>type()</code>动态创建类以外，要控制类的创建行为，还可以使用<code>metaclass</code>。<code>metaclass</code>允许你创建类或者修改类。换句话说，你可以把类看成是<code>metaclass</code>创建出来的“实例”。</p>
<p>下面的代码使用元类将模块里所有的类的属性都修改为大写形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpperAttrMetaClass</span><span class="params">(type)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></span><br><span class="line">        uppercase_attrs = ((name.upper(), value) <span class="keyword">for</span> name, value <span class="keyword">in</span> attrs.items() <span class="keyword">if</span> <span class="keyword">not</span> name.startswith(<span class="string">'__'</span>))</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, dict(uppercase_attrs))</span><br></pre></td></tr></table></figure>
<p>有了<code>UpperAttrMetaClass</code>，在定义类的时候还要指示使用<code>UpperAttrMetaClass</code>来定制类，传入关键字参数<code>metaclass</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object, metaclass=UpperAttrMetaClass)</span>:</span></span><br><span class="line">    bar = <span class="string">'bip'</span></span><br></pre></td></tr></table></figure>
<p>当传入关键字参数<code>metaclass</code>时，它指示<code>Python</code>解释器在创建<code>Foo</code>类时，要通过<code>ListMetaclass.__new__()</code>来创建，在此，将类的属性都修改为大写形式然后，返回修改后的定义。</p>
<p><code>__new__()</code>方法接收到的参数依次是：</p>
<ol>
<li><p>当前准备创建的类的对象；</p>
</li>
<li><p>类的名字；</p>
</li>
<li><p>类继承的父类集合；</p>
</li>
<li><p>类的属性集合。</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(hasattr(Foo, <span class="string">'bar'</span>))</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(hasattr(Foo, <span class="string">'BAR'</span>))</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f = Foo()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(f.BAR)</span><br><span class="line">bip</span><br></pre></td></tr></table></figure>
<h3 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h3><p>设计<code>ORM</code>需要从上层调用者角度来设计，如：定义一个<code>User</code>类来操作对应的数据库表<code>User</code>，我们期待他写出这样的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">        定义类的属性到表列字段的映射：</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    __table__ = <span class="string">'users'</span></span><br><span class="line"></span><br><span class="line">    id = StringField(primary_key=<span class="keyword">True</span>, default=next_id, ddl=<span class="string">'varchar(50)'</span>)</span><br><span class="line">    email = StringField(ddl=<span class="string">'varchar(50)'</span>)</span><br><span class="line">    passwd = StringField(ddl=<span class="string">'varchar(50)'</span>)</span><br><span class="line">    name = StringField(ddl=<span class="string">'varchar(50)'</span>)</span><br><span class="line">    created_at = FloatField(default=time.time)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建实例:</span></span><br><span class="line">    user = User(email=<span class="string">'test@test.com'</span>, passwd=<span class="string">'123456'</span>, name=<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 存入数据库:</span></span><br><span class="line">    user.save()</span><br></pre></td></tr></table></figure>
<p>在<code>User</code>类中的<code>__table__</code>、<code>id</code>和<code>name</code>是类的属性，不是实例的属性。所以，在类级别上定义的属性用来描述<code>User</code>对象和表的映射关系，而实例属性必须通过<code>__init__()</code>方法去初始化，所以两者互不干扰.</p>
<h4 id="定义Field类"><a href="#定义Field类" class="headerlink" title="定义Field类"></a>定义Field类</h4><p><code>Field</code>类，它负责保存数据库表的字段名和字段类型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">        数据库表的字段名、字段类型、是不是主键、默认值</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, column_type, primary_key, default)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.column_type = column_type</span><br><span class="line">        self.primary_key = primary_key</span><br><span class="line">        self.default = default</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;%s, %s:%s&gt;'</span> % (self.__class__.__name__, self.column_type, self.name)</span><br></pre></td></tr></table></figure>
<h4 id="StringField、FloatField"><a href="#StringField、FloatField" class="headerlink" title="StringField、FloatField"></a>StringField、FloatField</h4><p>映射<code>varchar</code>的<code>StringField</code>，映射<code>rear</code>的<code>FloatField</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">        映射varchar</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, ddl=<span class="string">'varchar(100)'</span>, primary_key=False, default=None)</span>:</span></span><br><span class="line">        super(StringField, self).__init__(name, ddl, primary_key, default)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FloatField</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">        映射rear</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, primary_key=None, default=<span class="number">0.0</span>)</span>:</span></span><br><span class="line">        super(FloatField, self).__init__(name, <span class="string">'real'</span>, primary_key, default)</span><br></pre></td></tr></table></figure>
<p>在<code>Field</code>的基础上，进一步定义各种类型的<code>Field</code>，比如<code>IntegerField</code>等等。</p>
<h4 id="ModelMetaclass"><a href="#ModelMetaclass" class="headerlink" title="ModelMetaclass"></a>ModelMetaclass</h4><p><code>ModelMetaclass</code>用于保存子类如<code>User</code>的映射信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_args_string</span><span class="params">(num)</span>:</span></span><br><span class="line">    args = []</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(num):</span><br><span class="line">        args.append(<span class="string">'?'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">', '</span>.join(args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelMetaClass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">        映射信息</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'Model'</span>:</span><br><span class="line">            <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br><span class="line"></span><br><span class="line">        table_name = attrs.get(<span class="string">'__table__'</span>, <span class="keyword">None</span>) <span class="keyword">or</span> name</span><br><span class="line">        logging.info(<span class="string">'found model: %s (table: %s)'</span> % (name, table_name))</span><br><span class="line"></span><br><span class="line">        mappings = dict()</span><br><span class="line">        fields = []</span><br><span class="line">        primary_key = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(v, Field):</span><br><span class="line">                logging.info(<span class="string">'  found mapping: %s ==&gt; %s'</span> % (k, v))</span><br><span class="line">                mappings[k] = v</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> v.primary_key:</span><br><span class="line">                    <span class="comment"># 找到主键</span></span><br><span class="line">                    <span class="keyword">if</span> primary_key:</span><br><span class="line">                        <span class="keyword">raise</span> Exception(<span class="string">'Duplicate primary key for field: %s'</span> % k)</span><br><span class="line">                    primary_key = k</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    fields.append(k)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> primary_key:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Primary key not found.'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> mappings.keys():</span><br><span class="line">            attrs.pop(k)</span><br><span class="line"></span><br><span class="line">        escaped_fields = list(map(<span class="keyword">lambda</span> field: <span class="string">'`%s`'</span> % field, fields))</span><br><span class="line">        attrs[<span class="string">'__mappings__'</span>] = mappings  <span class="comment"># 保存属性和列的映射关系</span></span><br><span class="line">        attrs[<span class="string">'__table__'</span>] = table_name  <span class="comment"># 表名</span></span><br><span class="line">        attrs[<span class="string">'__primary_key__'</span>] = primary_key  <span class="comment"># 主键属性名</span></span><br><span class="line">        attrs[<span class="string">'__fields__'</span>] = fields  <span class="comment"># 除主键外的属性名</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 对应数据库的select操作</span></span><br><span class="line">        attrs[<span class="string">'__select__'</span>] = <span class="string">'select `%s`, %s from `%s`'</span> % (</span><br><span class="line">            primary_key,</span><br><span class="line">            <span class="string">', '</span>.join(escaped_fields),</span><br><span class="line">            table_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 对应数据库的insert操作</span></span><br><span class="line">        attrs[<span class="string">'__insert__'</span>] = <span class="string">'insert into `%s` (%s, `%s`) values (%s)'</span> % (</span><br><span class="line">            table_name,</span><br><span class="line">            <span class="string">', '</span>.join(escaped_fields),</span><br><span class="line">            primary_key,</span><br><span class="line">            create_args_string(len(escaped_fields) + <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 对应数据库的update操作</span></span><br><span class="line">        attrs[<span class="string">'__update__'</span>] = <span class="string">'update `%s` set %s where `%s`=?'</span> % (</span><br><span class="line">            table_name,</span><br><span class="line">            <span class="string">','</span>.join(map(<span class="keyword">lambda</span> field: <span class="string">'`%s`=?'</span> % (mappings.get(field).name <span class="keyword">or</span> field), fields)),</span><br><span class="line">            primary_key)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 对应数据库的delete操作</span></span><br><span class="line">        attrs[<span class="string">'__delete__'</span>] = <span class="string">'delete from `%s` where `%s`=?'</span> % (table_name, primary_key)</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br></pre></td></tr></table></figure>
<p>在<code>ModelMetaclass</code>中，一共做了几件事情：</p>
<ol>
<li><p>排除掉对<code>Model</code>类的修改</p>
</li>
<li><p>把表名保存到<code>__table__</code>中，如果当前类没有定义<code>__table__</code>属性，则使用类名作为表名</p>
</li>
<li><p>在当前类（比如<code>User</code>）中查找定义的类的所有属性，如果找到一个<code>Field</code>属性，就把它保存到一个<code>__mappings__</code>的<code>dict</code>中，防止主键属性重复；</p>
</li>
<li><p>从类属性中删除该<code>Field</code>属性，否则，容易造成运行时错误（实例的属性会遮盖类的同名属性）</p>
</li>
<li><p><code>__select__</code>、<code>__insert__</code>、<code>__update__</code>等，对应于数据表的<code>SQL</code>操作</p>
</li>
</ol>
<h4 id="定义Model"><a href="#定义Model" class="headerlink" title="定义Model"></a>定义Model</h4><p>当用户定义一个<code>class User(Model)</code>时，<code>Python</code>解释器首先在当前类<code>User</code>的定义中查找<code>metaclass</code>，如果没有找到，就继续在父类<code>Model</code>中查找<code>metaclass</code>，找到了，就使用<code>Model</code>中定义的<code>metaclass</code>的<code>ModelMetaclass</code>来创建<code>User</code>类，也就是说，<code>metaclass</code>可以隐式地继承到子类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span><span class="params">(dict, metaclass=ModelMetaClass)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **kw)</span>:</span></span><br><span class="line">        super(Model, self).__init__(**kw)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self[key]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">r"'Model' object has no attribute '%s'"</span> % key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_value</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self, key, <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_value_or_default</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">            获得属性值，如果属性值不存在，则判断是否有默认的属性值</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        value = getattr(self, key, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            field = self.__mappings__[key]</span><br><span class="line">            <span class="keyword">if</span> field.default <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                value = field.default() <span class="keyword">if</span> callable(field.default) <span class="keyword">else</span> field.default</span><br><span class="line">                setattr(self, key, value)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self)</span>:</span></span><br><span class="line">        args = list(map(self.get_value_or_default, self.__fields__))</span><br><span class="line">        args.append(self.get_value_or_default(self.__primary_key__))</span><br><span class="line">        rows = <span class="keyword">await</span> execute(self.__insert__, args)</span><br><span class="line">        <span class="keyword">if</span> rows != <span class="number">1</span>:</span><br><span class="line">            logging.warning(<span class="string">'failed to insert record: affected rows: %s'</span> % rows)</span><br></pre></td></tr></table></figure>
<p><code>Model</code>从<code>dict</code>继承，所以具备所有<code>dict</code>的功能，同时又实现了特殊方法<code>__getattr__()</code>和<code>__setattr__()</code>，因此又可以像引用普通字段那样写:</p>
<pre><code>&gt;&gt;&gt; user[&apos;id&apos;]
123
&gt;&gt;&gt; user.id
123
</code></pre><p><code>Model</code>类定义了一个<code>save</code>的实例方法，可以把一个<code>User</code>实例存入数据库，<code>save</code>方法使用的异步IO来操作数据库：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = User(email=<span class="string">'test@test.com'</span>, passwd=<span class="string">'123456'</span>, name=<span class="string">'test'</span>)</span><br><span class="line"><span class="keyword">await</span> user.save()</span><br></pre></td></tr></table></figure>
<p><code>get_value_or_default</code>函数获得对应属性的值，如果对应属性的值为<code>None</code>，则取<code>__mappings__</code>里的默认值，如果<code>default</code>属性是<code>callable</code>，则取出调用后的值。如<code>User</code>类的<code>id</code>属性为<code>default=next_id</code>。</p>
<h4 id="创建连接池"><a href="#创建连接池" class="headerlink" title="创建连接池"></a>创建连接池</h4><p>上面的<code>save</code>方法使用的是异步IO来操作数据库，在<code>Python</code>中，<code>aiomysql</code>为<code>MySQL</code>数据库提供了异步IO的驱动。</p>
<p>下面的代码创建了一个连接池，由全局变量<code>__pool</code>存储:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_pool</span><span class="params">(loop, **kw)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">        创建数据库连接池</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    logging.info(<span class="string">'create database connection pool...'</span>)</span><br><span class="line">    <span class="keyword">global</span> __pool</span><br><span class="line">    __pool = <span class="keyword">await</span> aiomysql.create_pool(</span><br><span class="line">        host=kw.get(<span class="string">'host'</span>, <span class="string">'localhost'</span>),</span><br><span class="line">        port=kw.get(<span class="string">'port'</span>, <span class="number">3306</span>),</span><br><span class="line">        user=kw[<span class="string">'user'</span>],</span><br><span class="line">        password=kw[<span class="string">'password'</span>],</span><br><span class="line">        db=kw[<span class="string">'db'</span>],</span><br><span class="line">        charset=kw.get(<span class="string">'charset'</span>, <span class="string">'utf8'</span>),</span><br><span class="line">        autocommit=kw.get(<span class="string">'autocommit'</span>, <span class="keyword">True</span>),</span><br><span class="line">        maxsize=kw.get(<span class="string">'maxsize'</span>, <span class="number">10</span>),</span><br><span class="line">        minsize=kw.get(<span class="string">'minsize'</span>, <span class="number">1</span>),</span><br><span class="line">        loop=loop</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h4 id="执行INSERT语句"><a href="#执行INSERT语句" class="headerlink" title="执行INSERT语句"></a>执行INSERT语句</h4><p>上面的<code>Model</code>类的<code>save</code>的实例方法，可以把一个实例对象保存到数据库中，由<code>excute</code>函数执行<code>insert</code>语句来完成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(sql, args=<span class="params">()</span>)</span>:</span></span><br><span class="line">    logging.info(<span class="string">'SQL: %s'</span> % sql)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(sql, args, autocommit=True)</span>:</span></span><br><span class="line">    log(sql)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> __pool.get() <span class="keyword">as</span> conn:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> autocommit:</span><br><span class="line">            <span class="keyword">await</span> conn.begin()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> conn.cursor(aiomysql.DictCursor) <span class="keyword">as</span> cur:</span><br><span class="line">                <span class="keyword">await</span> cur.execute(sql.replace(<span class="string">'?'</span>, <span class="string">'%s'</span>), args)</span><br><span class="line">                affected = cur.rowcount</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> autocommit:</span><br><span class="line">                <span class="keyword">await</span> conn.commit()</span><br><span class="line">        <span class="keyword">except</span> BaseException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> autocommit:</span><br><span class="line">                <span class="keyword">await</span> conn.rollback()</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> affected</span><br></pre></td></tr></table></figure>
<h4 id="编写Model"><a href="#编写Model" class="headerlink" title="编写Model"></a>编写Model</h4><p>创建一个<code>users</code>表对应的<code>Model</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> orm <span class="keyword">import</span> Model, StringField, FloatField</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next_id</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'%015d%s000'</span> % (int(time.time() * <span class="number">1000</span>), uuid.uuid4().hex)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">        定义类的属性到表列字段的映射：</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    __table__ = <span class="string">'users'</span></span><br><span class="line"></span><br><span class="line">    id = StringField(primary_key=<span class="keyword">True</span>, default=next_id, ddl=<span class="string">'varchar(50)'</span>)</span><br><span class="line">    email = StringField(ddl=<span class="string">'varchar(50)'</span>)</span><br><span class="line">    passwd = StringField(ddl=<span class="string">'varchar(50)'</span>)</span><br><span class="line">    name = StringField(ddl=<span class="string">'varchar(50)'</span>)</span><br><span class="line">    created_at = FloatField(default=time.time)</span><br></pre></td></tr></table></figure>
<h4 id="初始化数据库表"><a href="#初始化数据库表" class="headerlink" title="初始化数据库表"></a>初始化数据库表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="keyword">test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span>, <span class="keyword">insert</span>, <span class="keyword">update</span>, <span class="keyword">delete</span> <span class="keyword">on</span> test.* <span class="keyword">to</span> <span class="string">'heqingliang'</span>@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'heqingliang'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">users</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="string">`passwd`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="string">`created_at`</span> <span class="built_in">real</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">unique</span> <span class="keyword">key</span> <span class="string">`idx_email`</span> (<span class="string">`email`</span>),</span><br><span class="line">    <span class="keyword">key</span> <span class="string">`idx_created_at`</span> (<span class="string">`created_at`</span>),</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">engine</span>=<span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=utf8;</span><br></pre></td></tr></table></figure>
<p>把<code>SQL</code>脚本放到<code>MySQL</code>命令行里执行：</p>
<pre><code>mysql -u root -p &lt; schema.sql
</code></pre><p>可以在数据库中看到，创建了一个<code>test</code>数据库，并创建类一个<code>users</code>表，<code>users</code>表中字段对应于<code>User</code>类的各个属性：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; USE test;</span><br><span class="line">mysql&gt; DESC users;</span><br><span class="line">+<span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br><span class="line">| Field      | Type        | Null | Key | Default | Extra |</span><br><span class="line">+<span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br><span class="line">| id         | varchar(50) | NO   | PRI | NULL    |       |</span><br><span class="line">| email      | varchar(50) | NO   | UNI | NULL    |       |</span><br><span class="line">| passwd     | varchar(50) | NO   |     | NULL    |       |</span><br><span class="line">| name       | varchar(50) | NO   |     | NULL    |       |</span><br><span class="line">| created_at | double      | NO   | MUL | NULL    |       |</span><br><span class="line">+<span class="comment">------------+-------------+------+-----+---------+-------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="编写数据访问代码"><a href="#编写数据访问代码" class="headerlink" title="编写数据访问代码"></a>编写数据访问代码</h4><p>接下来，就可以真正开始编写代码操作对象了。比如，对于<code>User</code>对象，我们就可以做如下操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> orm</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(loop)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> orm.create_pool(user=<span class="string">'heqingliang'</span>, password=<span class="string">'heqingliang'</span>, db=<span class="string">'test'</span>, loop=loop)</span><br><span class="line"></span><br><span class="line">    users = [</span><br><span class="line">        User(email=<span class="string">'test1@test.com'</span>, passwd=<span class="string">'123456'</span>, name=<span class="string">'test1'</span>),</span><br><span class="line">        User(email=<span class="string">'test2@test.com'</span>, passwd=<span class="string">'123456'</span>, name=<span class="string">'test2'</span>),</span><br><span class="line">        User(email=<span class="string">'test3@test.com'</span>, passwd=<span class="string">'123456'</span>, name=<span class="string">'test3'</span>),</span><br><span class="line">        User(email=<span class="string">'test4@test.com'</span>, passwd=<span class="string">'123456'</span>, name=<span class="string">'test2'</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> u <span class="keyword">in</span> users:</span><br><span class="line">        <span class="keyword">await</span> u.save()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(test(loop))</span><br><span class="line">    loop.run_forever()</span><br></pre></td></tr></table></figure>
<p>执行成功后，可以到如下<code>log</code>：</p>
<pre><code>INFO:root:found model: User (table: users)
INFO:root:  found mapping: passwd ==&gt; &lt;StringField, varchar(50):None&gt;
INFO:root:  found mapping: id ==&gt; &lt;StringField, varchar(50):None&gt;
INFO:root:  found mapping: email ==&gt; &lt;StringField, varchar(50):None&gt;
INFO:root:  found mapping: name ==&gt; &lt;StringField, varchar(50):None&gt;
INFO:root:  found mapping: created_at ==&gt; &lt;FloatField, real:None&gt;
INFO:root:create database connection pool...
INFO:root:SQL: insert into `users` (`passwd`, `email`, `name`, `created_at`, `id`) values (?, ?, ?, ?, ?)
INFO:root:SQL: insert into `users` (`passwd`, `email`, `name`, `created_at`, `id`) values (?, ?, ?, ?, ?)
INFO:root:SQL: insert into `users` (`passwd`, `email`, `name`, `created_at`, `id`) values (?, ?, ?, ?, ?)
INFO:root:SQL: insert into `users` (`passwd`, `email`, `name`, `created_at`, `id`) values (?, ?, ?, ?, ?)
</code></pre><p>查看数据库，可以看到数据插入成功：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM users;</span><br><span class="line">+<span class="comment">----------------------------------------------------+----------------+--------+-------+------------------+</span></span><br><span class="line">| id                                                 | email          | passwd | name  | created_at       |</span><br><span class="line">+<span class="comment">----------------------------------------------------+----------------+--------+-------+------------------+</span></span><br><span class="line">| 001527820029534e0c48803c8cc4c44a278d1491190a069000 | test1@test.com | 123456 | test1 | 1527820029.53404 |</span><br><span class="line">| 0015278200295492bdd1c9ba409444eb35211844501a663000 | test2@test.com | 123456 | test2 | 1527820029.54944 |</span><br><span class="line">| 0015278200295619ab4469834ec4b3290a460d079c91f3b000 | test3@test.com | 123456 | test3 | 1527820029.56111 |</span><br><span class="line">| 0015278200295635ed7e1100f294efb8b6ef8f57dbd7188000 | test4@test.com | 123456 | test2 | 1527820029.56394 |</span><br><span class="line">+<span class="comment">----------------------------------------------------+----------------+--------+-------+------------------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h4 id="SELECT语句"><a href="#SELECT语句" class="headerlink" title="SELECT语句"></a>SELECT语句</h4><h5 id="根据主键查找"><a href="#根据主键查找" class="headerlink" title="根据主键查找"></a>根据主键查找</h5><p>在<code>Model</code>类中定义一个<code>find</code>的类方法，<code>find</code>函数根据传入的主键执行<code>select</code>函数，返回相应的记录。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span><span class="params">(dict, metaclass=ModelMetaClass)</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">find</span><span class="params">(cls, pk)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">            根据主键查找</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        rs = <span class="keyword">await</span> select(<span class="string">'%s where `%s`=?'</span> % (cls.__select__, cls.__primary_key__), [pk], <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> len(rs) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">return</span> cls(**rs[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<h5 id="select函数"><a href="#select函数" class="headerlink" title="select函数"></a>select函数</h5><p><code>select</code>函数从数据库查找相应的记录：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(sql, args, size=None)</span>:</span></span><br><span class="line">    log(sql, args)</span><br><span class="line">    <span class="keyword">global</span> __pool</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> __pool.get() <span class="keyword">as</span> conn:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> conn.cursor(aiomysql.DictCursor) <span class="keyword">as</span> cur:</span><br><span class="line">            <span class="keyword">await</span> cur.execute(sql.replace(<span class="string">'?'</span>, <span class="string">'%s'</span>), args <span class="keyword">or</span> ())</span><br><span class="line">            <span class="keyword">if</span> size:</span><br><span class="line">                rs = <span class="keyword">await</span> cur.fetchmany(size)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                rs = <span class="keyword">await</span> cur.fetchall()</span><br><span class="line">        logging.info(<span class="string">'rows returned: %s'</span> % len(rs))</span><br><span class="line">        <span class="keyword">return</span> rs</span><br></pre></td></tr></table></figure>
<p>执行下面<code>find</code>方法的调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(loop)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> orm.create_pool(user=<span class="string">'heqingliang'</span>, password=<span class="string">'heqingliang'</span>, db=<span class="string">'test'</span>, loop=loop)</span><br><span class="line"></span><br><span class="line">    user = <span class="keyword">await</span> User.find(<span class="string">'001527820029534e0c48803c8cc4c44a278d1491190a069000'</span>)</span><br><span class="line">    print(user)</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<pre><code>INFO:root:create database connection pool...
INFO:root:SQL: select `id`, `name`, `created_at`, `email`, `passwd` from `users` where `id`=?
INFO:root:rows returned: 1
{&apos;created_at&apos;: 1527820029.53404, &apos;id&apos;: &apos;001527820029534e0c48803c8cc4c44a278d1491190a069000&apos;, &apos;email&apos;: &apos;test1@test.com&apos;, &apos;passwd&apos;: &apos;123456&apos;, &apos;name&apos;: &apos;test1&apos;}
</code></pre><h5 id="根据where、order-by、limit查找"><a href="#根据where、order-by、limit查找" class="headerlink" title="根据where、order by、limit查找"></a>根据where、order by、limit查找</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span><span class="params">(dict, metaclass=ModelMetaClass)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">find_all</span><span class="params">(cls, where=None, args=None, **kw)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">            根据指定的条件查找</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        sql = [cls.__select__]</span><br><span class="line">        <span class="keyword">if</span> where:</span><br><span class="line">            sql.append(<span class="string">'where'</span>)</span><br><span class="line">            sql.append(where)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> args <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            args = []</span><br><span class="line"></span><br><span class="line">        order_by = kw.get(<span class="string">'order_by'</span>, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">if</span> order_by:</span><br><span class="line">            sql.append(<span class="string">'order by'</span>)</span><br><span class="line">            sql.append(order_by)</span><br><span class="line"></span><br><span class="line">        limit = kw.get(<span class="string">'limit'</span>, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">if</span> limit <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            sql.append(<span class="string">'limit'</span>)</span><br><span class="line">            <span class="keyword">if</span> isinstance(limit, int):</span><br><span class="line">                sql.append(<span class="string">'?'</span>)</span><br><span class="line">                args.append(limit)</span><br><span class="line">            <span class="keyword">elif</span> isinstance(limit, tuple) <span class="keyword">and</span> len(limit) == <span class="number">2</span>:</span><br><span class="line">                sql.append(<span class="string">'?, ?'</span>)</span><br><span class="line">                args.extend(limit)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">'Invalid limit value: %s'</span> % str(limit))</span><br><span class="line"></span><br><span class="line">        rs = <span class="keyword">await</span> select(<span class="string">' '</span>.join(sql), args)</span><br><span class="line">        <span class="keyword">return</span> [cls(**r) <span class="keyword">for</span> r <span class="keyword">in</span> rs]</span><br></pre></td></tr></table></figure>
<p><strong>默认查找数据表中的所有记录，如下代码：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(loop)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> orm.create_pool(user=<span class="string">'heqingliang'</span>, password=<span class="string">'heqingliang'</span>, db=<span class="string">'test'</span>, loop=loop)</span><br><span class="line"></span><br><span class="line">    users = <span class="keyword">await</span> User.find_all()</span><br><span class="line">    print(users)</span><br></pre></td></tr></table></figure>
<p>输出如下结果：</p>
<pre><code>INFO:root:create database connection pool...
INFO:root:SQL: select `id`, `email`, `passwd`, `created_at`, `name` from `users`
INFO:root:rows returned: 4
[{&apos;id&apos;: &apos;001527820029534e0c48803c8cc4c44a278d1491190a069000&apos;, &apos;email&apos;: &apos;test1@test.com&apos;, &apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.53404, &apos;name&apos;: &apos;test1&apos;}, {&apos;id&apos;: &apos;0015278200295492bdd1c9ba409444eb35211844501a663000&apos;, &apos;email&apos;: &apos;test2@test.com&apos;, &apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.54944, &apos;name&apos;: &apos;test2&apos;}, {&apos;id&apos;: &apos;0015278200295619ab4469834ec4b3290a460d079c91f3b000&apos;, &apos;email&apos;: &apos;test3@test.com&apos;, &apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.56111, &apos;name&apos;: &apos;test3&apos;}, {&apos;id&apos;: &apos;0015278200295635ed7e1100f294efb8b6ef8f57dbd7188000&apos;, &apos;email&apos;: &apos;test4@test.com&apos;, &apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.56394, &apos;name&apos;: &apos;test2&apos;}]
</code></pre><p><strong>根据where条件查找，如下代码：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(loop)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> orm.create_pool(user=<span class="string">'heqingliang'</span>, password=<span class="string">'heqingliang'</span>, db=<span class="string">'test'</span>, loop=loop)</span><br><span class="line"></span><br><span class="line">    users = <span class="keyword">await</span> User.find_all(<span class="string">'name=?'</span>, [<span class="string">'test2'</span>])</span><br><span class="line">    print(users)</span><br></pre></td></tr></table></figure>
<p>输出如下结果:</p>
<pre><code>INFO:root:create database connection pool...
INFO:root:SQL: select `id`, `created_at`, `email`, `passwd`, `name` from `users` where name=?
INFO:root:rows returned: 2
[{&apos;created_at&apos;: 1527820029.54944, &apos;name&apos;: &apos;test2&apos;, &apos;email&apos;: &apos;test2@test.com&apos;, &apos;passwd&apos;: &apos;123456&apos;, &apos;id&apos;: &apos;0015278200295492bdd1c9ba409444eb35211844501a663000&apos;}, {&apos;created_at&apos;: 1527820029.56394, &apos;name&apos;: &apos;test2&apos;, &apos;email&apos;: &apos;test4@test.com&apos;, &apos;passwd&apos;: &apos;123456&apos;, &apos;id&apos;: &apos;0015278200295635ed7e1100f294efb8b6ef8f57dbd7188000&apos;}]
</code></pre><p><strong>使用limit，如下代码：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(loop)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> orm.create_pool(user=<span class="string">'heqingliang'</span>, password=<span class="string">'heqingliang'</span>, db=<span class="string">'test'</span>, loop=loop)</span><br><span class="line"></span><br><span class="line">    users = <span class="keyword">await</span> User.find_all(limit=(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">    print(users)</span><br></pre></td></tr></table></figure>
<p>输出如下结果:</p>
<pre><code>INFO:root:create database connection pool...
INFO:root:SQL: select `id`, `passwd`, `email`, `created_at`, `name` from `users` limit ?, ?
INFO:root:rows returned: 2
[{&apos;passwd&apos;: &apos;123456&apos;, &apos;email&apos;: &apos;test2@test.com&apos;, &apos;name&apos;: &apos;test2&apos;, &apos;created_at&apos;: 1527820029.54944, &apos;id&apos;: &apos;0015278200295492bdd1c9ba409444eb35211844501a663000&apos;}, {&apos;passwd&apos;: &apos;123456&apos;, &apos;email&apos;: &apos;test3@test.com&apos;, &apos;name&apos;: &apos;test3&apos;, &apos;created_at&apos;: 1527820029.56111, &apos;id&apos;: &apos;0015278200295619ab4469834ec4b3290a460d079c91f3b000&apos;}]
</code></pre><p><strong>使用where、limit查找，如下代码：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(loop)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> orm.create_pool(user=<span class="string">'heqingliang'</span>, password=<span class="string">'heqingliang'</span>, db=<span class="string">'test'</span>, loop=loop)</span><br><span class="line"></span><br><span class="line">    users = <span class="keyword">await</span> User.find_all(<span class="string">'name=?'</span>, [<span class="string">'test2'</span>], limit=<span class="number">1</span>)</span><br><span class="line">    print(users)</span><br></pre></td></tr></table></figure>
<p>输出如下结果:</p>
<pre><code>INFO:root:create database connection pool...
INFO:root:SQL: select `id`, `passwd`, `created_at`, `name`, `email` from `users` where name=? limit ?
INFO:root:rows returned: 1
[{&apos;name&apos;: &apos;test2&apos;, &apos;email&apos;: &apos;test2@test.com&apos;, &apos;id&apos;: &apos;0015278200295492bdd1c9ba409444eb35211844501a663000&apos;, &apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.54944}]
</code></pre><p><strong>使用order by，如下代码：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(loop)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> orm.create_pool(user=<span class="string">'heqingliang'</span>, password=<span class="string">'heqingliang'</span>, db=<span class="string">'test'</span>, loop=loop)</span><br><span class="line">    </span><br><span class="line">    users = <span class="keyword">await</span> User.find_all(order_by=<span class="string">'name'</span>)</span><br><span class="line">    print(users)</span><br></pre></td></tr></table></figure>
<p>输出如下结果:</p>
<pre><code>INFO:root:create database connection pool...
INFO:root:SQL: select `id`, `created_at`, `name`, `email`, `passwd` from `users` order by name
INFO:root:rows returned: 4
[{&apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.53404, &apos;id&apos;: &apos;001527820029534e0c48803c8cc4c44a278d1491190a069000&apos;, &apos;name&apos;: &apos;test1&apos;, &apos;email&apos;: &apos;test1@test.com&apos;}, {&apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.54944, &apos;id&apos;: &apos;0015278200295492bdd1c9ba409444eb35211844501a663000&apos;, &apos;name&apos;: &apos;test2&apos;, &apos;email&apos;: &apos;test2@test.com&apos;}, {&apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.56394, &apos;id&apos;: &apos;0015278200295635ed7e1100f294efb8b6ef8f57dbd7188000&apos;, &apos;name&apos;: &apos;test2&apos;, &apos;email&apos;: &apos;test4@test.com&apos;}, {&apos;passwd&apos;: &apos;123456&apos;, &apos;created_at&apos;: 1527820029.56111, &apos;id&apos;: &apos;0015278200295619ab4469834ec4b3290a460d079c91f3b000&apos;, &apos;name&apos;: &apos;test3&apos;, &apos;email&apos;: &apos;test3@test.com&apos;}]
</code></pre><h4 id="其他SQL语句"><a href="#其他SQL语句" class="headerlink" title="其他SQL语句"></a>其他SQL语句</h4><p>上面实现了数据库的<code>insert</code>、<code>select</code>操作，还可以自行定义其他<code>SQL</code>的执行操作，如<code>uptate</code>、<code>delete</code>，代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span><span class="params">(dict, metaclass=ModelMetaClass)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self)</span>:</span></span><br><span class="line">        args = list(map(self.getValue, self.__fields__))</span><br><span class="line">        args.append(self.getValue(self.__primary_key__))</span><br><span class="line">        rows = <span class="keyword">await</span> execute(self.__update__, args)</span><br><span class="line">        <span class="keyword">if</span> rows != <span class="number">1</span>:</span><br><span class="line">            logging.warn(<span class="string">'failed to update by primary key: affected rows: %s'</span> % rows)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(self)</span>:</span></span><br><span class="line">        args = [self.getValue(self.__primary_key__)]</span><br><span class="line">        rows = <span class="keyword">await</span> execute(self.__delete__, args)</span><br><span class="line">        <span class="keyword">if</span> rows != <span class="number">1</span>:</span><br><span class="line">            logging.warn(<span class="string">'failed to remove by primary key: affected rows: %s'</span> % rows)</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/28/buffer_cache_swap/" rel="next" title="Linux下的buffers/cache/swap">
                <i class="fa fa-chevron-left"></i> Linux下的buffers/cache/swap
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/03/web_framework/" rel="prev" title="编写python Web框架">
                编写python Web框架 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/dva.jpg"
                alt="heqingliang" />
            
              <p class="site-author-name" itemprop="name">heqingliang</p>
              <p class="site-description motion-element" itemprop="description">曾梦想仗剑走天涯 看一看世界的繁华 年少的心总有些轻狂 如今你四海为家 曾让你心疼的姑娘 如今已悄然无踪影</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#元类"><span class="nav-number">1.</span> <span class="nav-text">元类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#type"><span class="nav-number">1.1.</span> <span class="nav-text">type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#metaclass"><span class="nav-number">1.2.</span> <span class="nav-text">metaclass</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ORM"><span class="nav-number">2.</span> <span class="nav-text">ORM</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义Field类"><span class="nav-number">2.1.</span> <span class="nav-text">定义Field类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StringField、FloatField"><span class="nav-number">2.2.</span> <span class="nav-text">StringField、FloatField</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ModelMetaclass"><span class="nav-number">2.3.</span> <span class="nav-text">ModelMetaclass</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义Model"><span class="nav-number">2.4.</span> <span class="nav-text">定义Model</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建连接池"><span class="nav-number">2.5.</span> <span class="nav-text">创建连接池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行INSERT语句"><span class="nav-number">2.6.</span> <span class="nav-text">执行INSERT语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写Model"><span class="nav-number">2.7.</span> <span class="nav-text">编写Model</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化数据库表"><span class="nav-number">2.8.</span> <span class="nav-text">初始化数据库表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写数据访问代码"><span class="nav-number">2.9.</span> <span class="nav-text">编写数据访问代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SELECT语句"><span class="nav-number">2.10.</span> <span class="nav-text">SELECT语句</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#根据主键查找"><span class="nav-number">2.10.1.</span> <span class="nav-text">根据主键查找</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#select函数"><span class="nav-number">2.10.2.</span> <span class="nav-text">select函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#根据where、order-by、limit查找"><span class="nav-number">2.10.3.</span> <span class="nav-text">根据where、order by、limit查找</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他SQL语句"><span class="nav-number">2.11.</span> <span class="nav-text">其他SQL语句</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">heqingliang</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
